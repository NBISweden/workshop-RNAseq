<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>PCA and Clustering</title>

<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link id="font-awesome-1-attachment" rel="attachment" href="site_libs/font-awesome-5.1.0/fonts/fontawesome-webfont.ttf"/>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="assets/lab.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
#TOC {
  display: none !important;
}
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">






</div>


<!-- rmd lab header -->
<p><br></p>
<div class="boxy boxy-exclamation boxy-yellow">
<p>Set <code>~/RNAseq/labs/</code> as your working directory (i.e. your working directory should be the directory where you saved this .Rmd file). Create a subdirectory named <code>data</code> in this directory (<code>~/RNAseq/labs/data/</code>) for input and output files.</p>
</div>
<p>Load R packages.</p>
<pre class="r"><code>library(pheatmap) #plot heatmap
library(DESeq2) #differential gene expression for RNA-seq
library(pvclust) #clustering bootstrapping
library(biomaRt) #gene annotation
library(rafalib) #nice plot arrangement
rafalib::mypar(mar=c(6,2.5,2.5,1)) #sets nice arrangement for the whole document

# source download function
source(&quot;https://raw.githubusercontent.com/NBISweden/workshop-RNAseq/master/assets/scripts.R&quot;)</code></pre>
<p>Load the sequencing data and the metadata data with sample information.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code># Load data and metadata
download_data(&quot;data/counts_tpm.csv&quot;)
data &lt;- read.csv(&quot;data/counts_tpm.csv&quot;,header=TRUE,stringsAsFactors=FALSE,row.names=1)
data &lt;- log2( data + 1 )

# if file doesn&#39;t exist, download it
download_data(&quot;data/metadata_raw.csv&quot;)
metadata &lt;- read.csv(&quot;data/metadata_raw.csv&quot;,header=TRUE,stringsAsFactors=TRUE,row.names=1)</code></pre>
</div>
<div id="convert-ensembl-ids-to-gene-names" class="section level1">
<h1><span class="header-section-number">1</span> Convert ensembl IDs to gene names</h1>
<p>A useful step is to convert ENSEMBL gene/transcript IDs into meaningful gene names. This can be done in many way using a gtf file or using the <code>biomaRt</code> function in R.</p>
<pre class="r"><code>download_data(&quot;data/mouse_genes.txt&quot;)
mouse &lt;- biomaRt::useMart(biomart=&quot;ensembl&quot;, dataset=&quot;mmusculus_gene_ensembl&quot;)
annot &lt;- biomaRt::getBM(attributes = c(&quot;ensembl_gene_id&quot;,&quot;external_gene_name&quot;),mart = mouse,useCache=FALSE)

gene_names &lt;- as.character ( annot[match(rownames(data),annot[,&quot;ensembl_gene_id&quot;]),&quot;external_gene_name&quot;] )
gene_names[is.na(gene_names) ] &lt;- &quot;&quot;</code></pre>
<p>Remove missing or fuse duplicated annotations and sum transcripts into genes.</p>
<pre class="r"><code>data &lt;- rowsum(data, group = as.character(gene_names) ) #assign gene names and sum duplicates
data &lt;- data[ rownames(data) != &quot;&quot; , ] #remove blank annotation
data &lt;- data[ rownames(data) != &quot;NA&quot; , ] #remove blank annotation
data &lt;- data[ order(rownames(data)),]  #order genes alphabetically
dim(data)</code></pre>
<pre><code>## [1] 10554     6</code></pre>
<p>We can now save this counts for later use</p>
<pre class="r"><code>write.csv(data ,&quot;data/gene_tpm_counts.csv&quot;,row.names=T)

cf &lt;- read.csv(&quot;data/counts_filtered.csv&quot;,header=TRUE,stringsAsFactors=FALSE,row.names=1)
cf &lt;- rowsum(cf, group = as.character(gene_names) ) #assign gene names and sum duplicates
cf &lt;- cf[ rownames(cf) != &quot;&quot; , ] #remove blank annotation
cf &lt;- cf[ rownames(cf) != &quot;NA&quot; , ] #remove blank annotation
cf &lt;- cf[ order(rownames(cf)),]  #order genes alphabetically
write.csv(cf ,&quot;data/gene_counts.csv&quot;,row.names=T)</code></pre>
<hr />
</div>
<div id="pca" class="section level1">
<h1><span class="header-section-number">2</span> PCA</h1>
<p>Performing PCA has many useful applications and interpretations, which much depends on the data used. In the case of life sciences, we want to segregate samples based on gene expression patterns in the data.</p>
<div id="z-score-normalization" class="section level2">
<h2><span class="header-section-number">2.1</span> Z-score normalization</h2>
<p>Now that the data is prepared, we now proceed with PCA. Since each gene has a different expression level, it means that genes with higher expression values will naturally have higher variation that will be captured by PCA. This means that we need to somehow give each gene a similar weight when performing PCA (see below). The common practice is to center and scale each gene before performing PCA. This exact scaling is called <strong>Z-score</strong> normalization it is very useful for PCA, clustering and plotting heatmaps.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>Znorm &lt;- t(apply(data,1,function(x) scale(x,center=T,scale=T)))
colnames(Znorm) &lt;- colnames(data)

{
  mypar(1,2,mar=c(5,3,2,1))
  boxplot(t(data[1:30,]),ylim=c(0,12),las=2,col=&quot;grey&quot;,main=&quot;data raw_data&quot;,cex=.2)
  boxplot(t(Znorm[1:30,]),ylim=c(-4,4),las=2,col=&quot;grey&quot;,main=&quot;Z-score data&quot;,cex=.2)
  abline(h=0,col=&quot;red&quot;,lty=2)
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-7-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<hr />
</div>
<div id="gene-selection" class="section level2">
<h2><span class="header-section-number">2.2</span> Gene selection</h2>
<p>As you can appreciate above, Z-score normalization have set each gene mean to 0 and changes the variances to a common scale. However, if we normalize all genes to the same scale, even genes that could be considered stable across samples (i.e. that do not vary across your samples) will be used for separation of samples. This might in turn add ‘noise’ to your data in form of ‘variation across samples that are not meaningful’. Therefore, we can also sort the genes by variance and use the top genes to filter/prioritize the data.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>#Compute the mean, variance and cv for each gene and sort them in decreasing order
gene_stats &lt;- data.frame(row.names=rownames(data))
means &lt;- apply(data,1,mean)
vars &lt;- apply(data,1,var)

#Plot the row means versus row means
{
  mypar(1,2,mar=c(5,3,2,1))
  plot(means,vars,cex=.1)
}

#Sort and select the top 500 highly variable genes from the data
vars &lt;- sort(vars,decreasing=T)
top_var &lt;- names(vars)[1:500]
boxplot(t(data[top_var[1:15],]),ylim=c(0,12),las=2,col=&quot;grey&quot;, main=&quot;data (top var genes)&quot;,cex=.2)</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-8-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<hr />
</div>
<div id="computing-pca" class="section level2">
<h2><span class="header-section-number">2.3</span> Computing PCA</h2>
<p>Next, we can compute PCA using the <code>prcomp()</code> function. As additional parameters, we can already center and scale each gene already inside the function. This the same exact <strong>Z-score</strong> scaling above, but already inside the function.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>{
  mypar(1,2,mar = c(3,3,2,1))
  PC &lt;-  prcomp( t( Znorm[ top_var, ]) ) #Method1
  PC &lt;-  prcomp( t( data[ top_var, ]), center = TRUE, scale. = TRUE) #Method2

  mypar(1,2)
  plot(PC$x[,1],PC$x[,2],cex=2,col=factor(metadata$Group),xlab=&quot;PC1&quot;,ylab=&quot;PC2&quot;,pch=16,main=&quot;PCA&quot;,las=1)
  text(PC$x[,1],PC$x[,2],cex=.7,labels = paste0(metadata$SampleName),pos=3)

  plot(PC$x[,3],PC$x[,4],cex=2,col=factor(metadata$Group),xlab=&quot;PC3&quot;,ylab=&quot;PC4&quot;,pch=16,main=&quot;PCA&quot;,las=1)
  text(PC$x[,3],PC$x[,4],cex=.7,labels = paste0(metadata$SampleName),pos=3)
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-9-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>Which groups are clearly separated by PC1 and PC2?</li>
<li>Which groups are clearly separated by PC3 and PC4?</li>
<li>What happens if we include 2000 genes (rather than 500) in the PCA?</li>
<li>What happens if we include all genes in the PCA?</li>
<li>What happens if we use the raw CPM, rather than log2CPM for the PCA?</li>
<li>What happens if we don’t scale or centralize the data?</li>
<li>How does PC3 and PC4 look? Go back to the code above and change which PCs to plot.</li>
<li>Do PC10 and PC11 still separate your samples as well as PC1 and PC2?</li>
</ul>
<hr />
</div>
<div id="computing-pc-variance" class="section level2">
<h2><span class="header-section-number">2.4</span> Computing PC variance</h2>
<p>The usefulness of PCA is that the principal components do have a meaning: They store the amount of variance in decreasing order, so some PCs are more important than others. Inside the <code>PC$sdev</code> object, we can get the standard deviation stored in each PC.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>PC_sd &lt;- setNames(PC$sdev,paste0(&quot;PC&quot;,1:length(PC$sdev)))
PC_var_expl &lt;- (PC_sd^2)/sum(PC_sd^2)*100

{
  mypar(1,1)
  barplot(PC_var_expl,las=2,ylab=&quot;% variance explained&quot;)
  abline(h=10,lty=2)
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-10-1.svg" width="480" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>Which PCs explain at least 10% of variance?</li>
<li>Instead of using our whole data set, could we use only the top PCs for downstream analysis ? Explain.</li>
</ul>
<hr />
</div>
<div id="leading-genes" class="section level2">
<h2><span class="header-section-number">2.5</span> Leading genes</h2>
<p>Now that you know that each PC stores a particular structure of the data, we could also explore with genes are more responsible for that separation (a.k.a. leading genes). For that, we can take a look inside the PC object.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>leading_genes &lt;- PC$rotation
head(leading_genes)

leading_PC1 &lt;- sort(leading_genes[,1],decreasing=T)
leading_PC2 &lt;- sort(leading_genes[,2],decreasing=T)

{
  mypar(1,2,mar=c(3,4,2,2))
  barplot(leading_PC1[15:1],las=2,horiz=T,cex.names=.8,cex.axis=0.8,yaxs=&quot;i&quot;)
  abline(v=0,lwd=2)
  barplot(leading_PC2[15:1],las=2,horiz=T,cex.names=.8,cex.axis=0.8,yaxs=&quot;i&quot;)
  abline(v=0,lwd=2)
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-11-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>Which genes impact the most in PC1?</li>
<li>Which genes impact the most in PC2?</li>
</ul>
<hr />
</div>
</div>
<div id="hierarchical-clustering" class="section level1">
<h1><span class="header-section-number">3</span> Hierarchical clustering</h1>
<p>Hierarchical clustering is group of clustering methods used to group samples based on a hierarchy. The hierarchical clustering is done in two steps:</p>
<ul>
<li>Step1: Define the distances between samples. The most common are Euclidean distance (a.k.a. straight line between two points) or correlation coefficients.</li>
<li>Step2: Define the dendrogram among all samples using <strong>Bottom-up</strong> or <strong>Top-down</strong> approach. <strong>Bottom-up</strong> is where samples start with their own cluster which end up merged pair-by-pair until only one cluster is left. <strong>Top-down</strong> is where samples start all in the same cluster that end up being split by 2 until each sample has its own cluster.</li>
</ul>
<hr />
<div id="distance-between-samples" class="section level2">
<h2><span class="header-section-number">3.1</span> Distance between samples</h2>
<p>The base R <code>stats</code> package already contains a function <code>dist()</code> that calculates distances between all pairs of samples. Since we want to compute distances between samples, rather than among genes, we need to transpose the data before applying it to the <code>dist()</code> function. This can be done by simply adding the transpose function <code>t()</code> to the data. When clustering on genes, it is wise to first define the gene selection to reduce the time to compute distances. A sensible choice is to do it on the differentially expressed genes only (including up to ~3000 genes).</p>
<p>The distance methods available in <code>dist()</code> are: <em>euclidean</em>, <em>maximum</em>, <em>manhattan</em>, <em>canberra</em>, <em>binary</em> or <em>minkowski</em>.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>d &lt;- dist( t(data) , method=&quot;euclidean&quot;)
d</code></pre>
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>When printing the distance object, why is only half of the matrix shown?</li>
</ul>
<hr />
<p>As you might have realized, correlation is not a method implemented in the <code>dist()</code> function. However, we can create our own distances and transform them to a distance object.</p>
<p>We can first compute sample correlations using the <code>cor()</code> function. As you might already know, correlation range from -1 to 1, where 1 indicates that two samples are closest, -1 indicates that two samples are the furthest and 0 is somewhat in between. This, however, creates a problem in defining distances because a distance of 0 indicates that two samples are closest, 1 indicates that two samples are the furthest and distance of -1 is not meaningful. We thus need to transform the correlations to a positive scale (a.k.a. <strong>adjacency</strong>):</p>
<p><span class="math display">\[adj = -\frac{cor - 1}{2}\]</span></p>
<p>Once we transformed the correlations to a 0-1 scale, we can simply convert it to a distance object using <code>as.dist()</code> function. The transformation does not need to have a maximum of 1, but it is more intuitive to have it at 1, rather than at any other number.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>#Compute sample correlations
sample_cor &lt;- cor( data )
round(sample_cor,4)
pheatmap(sample_cor)

#Transform the scale from correlations
cor_distance &lt;- -(sample_cor-1)/2
round(cor_distance,4)
pheatmap(cor_distance)

#Convert it to a distance object
d2 &lt;- as.dist(cor_distance)
d2</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-13-1.svg" width="960" style="display: block; margin: auto auto auto 0;" /><img src="lab_eda_files/figure-html/unnamed-chunk-13-2.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>What is the adjacency distance between two samples with correlation <span class="math inline">\(r\)</span> of 0.8 ?</li>
<li>What is the adjacency distance between two samples with correlation <span class="math inline">\(r\)</span> of -0.6 ?</li>
<li>What happens if instead of using the formula above, we used the absolute value of <span class="math inline">\(r\)</span> ( <span class="math inline">\(|r|\)</span> ) as adjacency (this way all values will be also between 0-1). Does this change affects the interpretation of adjacency distances ?</li>
<li>What happens if instead of using the formula above, we used <span class="math inline">\(r^2\)</span> as adjacency (this way all values will be also between 0-1). Does this change affects the interpretation of adjacency distances ?</li>
</ul>
<hr />
</div>
<div id="clustering-samples" class="section level2">
<h2><span class="header-section-number">3.2</span> Clustering samples</h2>
<p>After having calculated the distances between samples calculated, we can now proceed with the hierarchical clustering per-se. We will use the function <code>hclust()</code> for this purpose, in which we can simply run it with the distance objects created above.</p>
<p>The methods available are: <em>ward.D</em>, <em>ward.D2</em>, <em>single</em>, <em>complete</em>, <em>average</em>, <em>mcquitty</em>, <em>median</em> or <em>centroid</em>.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>#Clustering using euclidean distance
{
  mypar(1,2,mar=c(6,4,2,1))
  h &lt;- hclust(d,method=&quot;complete&quot;)
  plot( as.dendrogram(h),las=1,main=&quot;d=euclidean\nh=complete&quot;)
  points(1:ncol(data),rep(0,ncol(data)),pch=16,cex=2,col=metadata$Group[h$order])
}


h2 &lt;- hclust(d2,method=&quot;complete&quot;)
{
  plot( as.dendrogram(h2),las=1, main=&quot;d=correlation\nh=complete&quot;)
  points(1:ncol(data),rep(0,ncol(data)),pch=16,cex=2, col=metadata$Group[h2$order])
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-14-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>Does the ordering of the samples in dendrogram has a meaning ?</li>
<li>Why are the scales between those dendrograms so different ? Look at the distance matrices to get the intuition.</li>
<li>Do the two methods represent the same results ? Which one would you trust the most ?</li>
<li>Does the ordering of the dendrogram have a meaning ?</li>
<li>Change the clustering method to <code>ward.D2</code>. How does it affect your results ?</li>
<li>We used the whole dataset for clustering. Re-calculate the distances now using only the top 500 genes with highest CV. Does it change the results ?</li>
<li>Instead of clustering on the raw data, could we cluster on the top <span class="math inline">\(N\)</span> principal components? Justify.</li>
</ul>
<hr />
</div>
<div id="defining-clusters" class="section level2">
<h2><span class="header-section-number">3.3</span> Defining clusters</h2>
<p>Once your dendrogram is created, the next step is to define which samples belong to a particular cluster. However, the sample groups are already known in this example, so clustering them does not add much information for us. What we can do instead is subdivide the genes into clusters. As for the PCA (above), the ideal scenario is to use the Z-score normalized gene expression table, because in this way we make sure that we are grouping together expression trends (going up vs. down), rather than expression level (genes with more counts vs less counts). This way, we can simply repeat the steps above using the transpose of the Z-score matrix, compute the correlation distances and cluster using ward.D2 linkage method. Since it is time consuming to cluster on all genes, this step is usually done only on the differentially expressed gene list (say up to ~3000 genes). Here, we can for instance cluster on the genes with highest variance <code>top_var</code>.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>gene_cor  &lt;- cor(t(Znorm[top_var, ]))
gene_dist &lt;- as.dist(-(gene_cor-1)/2)
gene_clus &lt;- hclust(gene_dist,method=&quot;complete&quot;)</code></pre>
</div>
<p>After identifying the dendrogram for the genes (below), we can now literally cut the tree at a fixed threshold (with <code>cutree</code>) at different levels to define the clusters.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>HEIGHT &lt;- 0.9
gene_clusters &lt;- cutree(gene_clus,h=HEIGHT)
gene_clusters

{
  mypar(1,1,mar=c(6,4,2,1))
  plot( as.dendrogram(gene_clus),las=1,main=&quot;d=correlation\nh=complete&quot;)

  rect.hclust(gene_clus,h=HEIGHT)
  abline(h=HEIGHT,col=&quot;red&quot;,lty=2)
  points(1:length(gene_clusters),rep(0,length(gene_clusters)),pch=16,cex=2, col=factor(gene_clusters)[gene_clus$order])
  legend(&quot;topright&quot;,levels(factor(gene_clusters)),pch=16,col=  factor(levels(factor(gene_clusters))))
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-16-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>Check the dendrogram above, what is a sensible height to cut the tree?</li>
<li>What is the maximum sensible amount of clusters I could have in my data?</li>
</ul>
<hr />
</div>
<div id="clustering-on-heatmap-optional" class="section level2">
<h2><span class="header-section-number">3.4</span> Clustering on Heatmap (optional)</h2>
<p>Now that you understand the concepts of hierarchical clustering both at the sample and at the gene level, we can use a heatmap function to explore the visual consequences of clustering. Here, we can make use of the <code>pheatmap</code> function, which by default will do the clustering of the rows and columns.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code>pheatmap( data[top_var,] , scale=&quot;row&quot; , color = colorRampPalette(c(&quot;navy&quot;,&quot;white&quot;,&quot;firebrick&quot;))(90), border_color=NA, cluster_cols=F)</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-17-1.svg" width="384" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>Check the dendrograms on the side of the heatmap. Do they look familiar with the previous ones?</li>
<li>What does the ‘scale’ parameter mean? What happens with the clustering if we change it to ‘none’ or to ‘columns’?</li>
<li>Can you change the clustering to ‘ward.D2’? Explore the <code>pheatmap</code> function pressing tab.</li>
<li>Can you cut your gene tree into 4 clusters? Explore the <code>pheatmap</code> function pressing tab.</li>
</ul>
<hr />
</div>
<div id="clustering-bootstrapping-optional" class="section level2">
<h2><span class="header-section-number">3.5</span> Clustering bootstrapping (optional)</h2>
<p>Let’s say that you have 12 samples, so that all samples have the exact same expression level (say 12000 genes). And to that you add 1 single gene which is more expressed in samples 6-12, than in 1-6. If you ran a bootstrapping in this <strong>mock example</strong>, you will see that the samples will seem to cluster very well enven though there is only 1 out 12000 genes that make that separation possible.</p>
<p>One way to measure <strong>clustering robustness / accuracy</strong> is by selecting part of the data set (say 90% of the genes), performing the clustering and recording which samples fall together. Then, you repeat (iterate) with another selection of 90% of the genes up to 1000 times, recording the clustering results. In the end, you compare the results of all 1000 clusterings and check how often the same samples failed in the same group. This procedure is called <strong>bootstrapping</strong>, and it is measured as the “percentage of times an event can occur”. For more details on this, please read the webpage for the <code>pvclust()</code> which is full of examples on this:</p>
<ul>
<li><code>pvclust</code> website: <a href="http://stat.sys.i.kyoto-u.ac.jp/prog/pvclust/" class="uri">http://stat.sys.i.kyoto-u.ac.jp/prog/pvclust/</a></li>
<li><code>pvclust</code> paper: <a href="https://academic.oup.com/bioinformatics/article/22/12/1540/207339" class="uri">https://academic.oup.com/bioinformatics/article/22/12/1540/207339</a></li>
</ul>
<p><i class="fas fa-exclamation-circle"></i> Note that bootstrapping procedure is very time consuming and computationally intensive. For this purpose, we will run it only on the top 100 most variable genes in the dataset.</p>
<div class="chunk-title-parent">
<div class="chunk-title small">
R
</div>
<pre class="r"><code># Clustering on our dataset (this step is slow)
pvc &lt;- pvclust( data = data[top_var[1:100],] , method.dist = &quot;correlation&quot;, method.hclust = &quot;complete&quot;)

{
  mypar()
  plot(pvc,las=2,hang = -0.5)
  pvrect(pvc, alpha = 0.9)
  points(1:ncol(data) ,rep(0,ncol(data)), pch= 16, cex=2, col=metadata$Group[pvc$hclust$order])
}</code></pre>
<img src="lab_eda_files/figure-html/unnamed-chunk-18-1.svg" width="960" style="display: block; margin: auto auto auto 0;" />
</div>
<p><i class="fas fa-comments"></i> <strong>Exploratory Questions</strong></p>
<ul>
<li>With what percentages the samples from DSSd00_1 and DSSd00_3 fall together in the same cluster?</li>
<li>With what percentages the samples from DSSd07_1 and DSSd07_2 fall together in the same cluster?</li>
<li>With what percentages the samples DSSd00 and DSSd07 fall together in the same cluster?</li>
<li>The orange rectangles represent 2 clusters. What do you think is the criteria used to define this clusters ? PS: it is not the height as in the previous examples. Check the code above.</li>
</ul>
<hr />
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
