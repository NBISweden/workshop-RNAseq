<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Data preprocessing</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link id="font-awesome-1-attachment" rel="attachment" href="site_libs/font-awesome-5.1.0/fonts/fontawesome-webfont.ttf"/>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="assets/lab.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
#TOC {
  display: none !important;
}
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"><img src="assets/logo.svg" id="logo" style="height:22px;margin:0;"/></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="home_schedule.html">Schedule</a>
</li>
<li>
  <a href="home_content.html">Content</a>
</li>
<li>
  <a href="home_precourse.html">Precourse</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Data preprocessing</h1>
<h3 class="subtitle">Workshop on RNA-Seq</h3>

</div>


<!-- rmd lab header -->
<p><br></p>
<div class="boxy boxy-exclamation boxy-warning">
<p>Create a directory named <code>data</code> in your current working directory for input and output files.</p>
</div>
<p>Data preprocessing is done in R. Load the necessary R packages and source the download function.</p>
<pre class="r"><code># plotting
library(DESeq2) # rna-seq
library(rafalib) # nice plot arrangement
rafalib::mypar(mar=c(6,2.5,2.5,1)) #sets nice arrangement for the whole document

# source download function
source(&quot;https://raw.githubusercontent.com/NBISweden/workshop-RNAseq/master/assets/scripts.R&quot;)</code></pre>
<p><br></p>
<div id="preparation" class="section level1">
<h1><span class="header-section-number">1</span> Preparation</h1>
<p>The first step is some data wrangling and clean-up to prepare the data for analyses. Download the count table generated by featureCounts into the <code>data/</code> subdirectory and name it <strong>gene_counts_original.tsv</strong>.</p>
<pre class="r"><code>if(!file.exists(&quot;data/gene_counts_original.tsv&quot;)) download.file(&quot;https://drive.google.com/uc?export=download&amp;id=1t3pVUDodyDsxe0kiiVNL6mIXDbj1Y3zB&quot;,&quot;data/gene_counts_original.tsv&quot;)</code></pre>
<p>Download the metadata table.</p>
<pre class="r"><code>download_data(&quot;data/metadata_original.csv&quot;)</code></pre>
<p>Read in the files to R.</p>
<pre class="r"><code>co &lt;- read.delim(&quot;data/gene_counts_original.tsv&quot;,sep=&quot;\t&quot;,header=TRUE,stringsAsFactors=F,comment.char=&quot;#&quot;)
mo &lt;- read.csv(&quot;data/metadata_original.csv&quot;,header=TRUE)</code></pre>
<p>Inspect how the files look like.</p>
<pre class="r"><code>head(co)
head(mo)</code></pre>
<pre><code>##               Geneid           Chr
## 1 ENSMUSG00000102693             1
## 2 ENSMUSG00000064842             1
## 3 ENSMUSG00000051951 1;1;1;1;1;1;1
## 4 ENSMUSG00000102851             1
## 5 ENSMUSG00000103377             1
## 6 ENSMUSG00000104017             1
##                                                     Start
## 1                                                 3073253
## 2                                                 3102016
## 3 3205901;3206523;3213439;3213609;3214482;3421702;3670552
## 4                                                 3252757
## 5                                                 3365731
## 6                                                 3375556
##                                                       End        Strand Length
## 1                                                 3074322             +   1070
## 2                                                 3102125             +    110
## 3 3207317;3207317;3215632;3216344;3216968;3421901;3671498 -;-;-;-;-;-;-   6094
## 4                                                 3253236             +    480
## 5                                                 3368549             -   2819
## 6                                                 3377788             -   2233
##   hisat2_results.subset_1M_reads.KI_PC1606_01.bam
## 1                                               0
## 2                                               0
## 3                                               0
## 4                                               0
## 5                                               0
## 6                                               0
##   hisat2_results.subset_1M_reads.KI_PC1606_02.bam
## 1                                               0
## 2                                               0
## 3                                               1
## 4                                               0
## 5                                               0
## 6                                               0
##   hisat2_results.subset_1M_reads.KI_PC1606_03.bam
## 1                                               0
## 2                                               0
## 3                                               2
## 4                                               0
## 5                                               0
## 6                                               0
##   hisat2_results.subset_1M_reads.KI_PC1606_13.bam
## 1                                               0
## 2                                               0
## 3                                               0
## 4                                               0
## 5                                               0
## 6                                               0
##   hisat2_results.subset_1M_reads.KI_PC1606_14.bam
## 1                                               0
## 2                                               0
## 3                                               3
## 4                                               0
## 5                                               0
## 6                                               0
##   hisat2_results.subset_1M_reads.KI_PC1606_15.bam
## 1                                               0
## 2                                               0
## 3                                               2
## 4                                               0
## 5                                               0
## 6                                               0
##   SampleName     SampleID No Model Day Group Replicate
## 1   DSSd00_1 KI_PC1606_01  1   DSS   0 day00         1
## 2   DSSd00_2 KI_PC1606_02  2   DSS   0 day00         2
## 3   DSSd00_3 KI_PC1606_03  3   DSS   0 day00         3
## 4   DSSd02_1 KI_PC1606_04  4   DSS   2 day02         1
## 5   DSSd02_2 KI_PC1606_05  5   DSS   2 day02         2
## 6   DSSd02_3 KI_PC1606_06  6   DSS   2 day02         3</code></pre>
<p>We need the count table to have only the counts (numeric data) with gene IDs as row names. And the metadata table must only include information for the samples that are in the count table. And in the same order.</p>
<pre class="r"><code>cr &lt;- co[,7:12]
rownames(cr) &lt;- co$Geneid
colnames(cr) &lt;- substr(colnames(cr),42,43)
mr &lt;- mo[mo$No %in% as.integer(colnames(cr)),]
colnames(cr) &lt;- mr$SampleName
rownames(mr) &lt;- mr$SampleName</code></pre>
<p>Then, we replace Ensembl gene IDs with Gene names. Remove NAs and duplicates.</p>
<pre class="r"><code>mouse &lt;- biomaRt::useMart(&quot;ensembl&quot;,dataset=&quot;mmusculus_gene_ensembl&quot;)
egn &lt;- biomaRt::getLDS(attributes=c(&quot;ensembl_gene_id&quot;),filters=&quot;ensembl_gene_id&quot;,values=rownames(cr),mart=mouse,attributesL=c(&quot;external_gene_name&quot;),martL=mouse,valuesL=&quot;external_gene_name&quot;,uniqueRows=F)
egn &lt;- na.omit(egn)
egn &lt;- egn[!duplicated(egn$Gene.name),]
cr &lt;- cr[rownames(cr) %in% egn$Gene.stable.ID,]

rownames(cr) &lt;- egn$Gene.name
cr &lt;- cr[order(rownames(cr)),]</code></pre>
<p>Inspect the new count table and metadata table. Ensure that labels match.</p>
<pre class="r"><code>head(cr)
mr
all.equal(colnames(cr),rownames(mr))</code></pre>
<pre><code>##               DSSd00_1 DSSd00_2 DSSd00_3 DSSd07_1 DSSd07_2 DSSd07_3
## 0610005C13Rik        0        0        0        0        0        0
## 0610006L08Rik        0        0        0        0        0        0
## 0610009B22Rik        0        0        0        0        0        0
## 0610009E02Rik        0        0        0        0        0        0
## 0610009L18Rik        0        0        0        0        0        0
## 0610010F05Rik       34       38       33       38       55       45
##          SampleName     SampleID No Model Day Group Replicate
## DSSd00_1   DSSd00_1 KI_PC1606_01  1   DSS   0 day00         1
## DSSd00_2   DSSd00_2 KI_PC1606_02  2   DSS   0 day00         2
## DSSd00_3   DSSd00_3 KI_PC1606_03  3   DSS   0 day00         3
## DSSd07_1   DSSd07_1 KI_PC1606_13 13   DSS   7 day07         1
## DSSd07_2   DSSd07_2 KI_PC1606_14 14   DSS   7 day07         2
## DSSd07_3   DSSd07_3 KI_PC1606_15 15   DSS   7 day07         3
## [1] TRUE</code></pre>
<p>Finally save the data in the <strong>data</strong> directory.</p>
<pre class="r"><code>write.csv(cr,file=&quot;data/gene_counts_raw.csv&quot;,quote=FALSE)
write.csv(mr,file=&quot;data/metadata_raw.csv&quot;,quote=FALSE)</code></pre>
</div>
<div id="filtering" class="section level1">
<h1><span class="header-section-number">2</span> Filtering</h1>
<p>The next step is to remove samples and genes that are uninformative. We read in the count table (<em>You can skip this step if continuing from the previous step</em>).</p>
<pre class="r"><code>download_data(&quot;data/gene_counts_raw.csv&quot;)
cr &lt;- read.csv(&quot;./data/gene_counts_raw.csv&quot;,header=TRUE,stringsAsFactors=FALSE,row.names=1)
head(cr)
str(cr)</code></pre>
<pre><code>##               DSSd00_1 DSSd00_2 DSSd00_3 DSSd07_1 DSSd07_2 DSSd07_3
## 0610005C13Rik        0        0        0        0        0        0
## 0610006L08Rik        0        0        0        0        0        0
## 0610009B22Rik        0        0        0        0        0        0
## 0610009E02Rik        0        0        0        0        0        0
## 0610009L18Rik        0        0        0        0        0        0
## 0610010F05Rik       34       38       33       38       55       45
## &#39;data.frame&#39;:    55367 obs. of  6 variables:
##  $ DSSd00_1: int  0 0 0 0 0 34 435 0 0 0 ...
##  $ DSSd00_2: int  0 0 0 0 0 38 635 0 0 0 ...
##  $ DSSd00_3: int  0 0 0 0 0 33 567 0 0 0 ...
##  $ DSSd07_1: int  0 0 0 0 0 38 393 0 0 0 ...
##  $ DSSd07_2: int  0 0 0 0 0 55 358 0 0 0 ...
##  $ DSSd07_3: int  0 0 0 0 0 45 261 0 0 0 ...</code></pre>
<p>The count data shows read counts across samples and genes. The columns denote samples and rows denote genes.</p>
<p>Read in the metadata (<em>You can skip this step if continuing from the previous step</em>). Each row corresponds to a sample.</p>
<pre class="r"><code>download_data(&quot;data/metadata_raw.csv&quot;)
mr &lt;- read.csv(&quot;./data/metadata_raw.csv&quot;,header=TRUE,stringsAsFactors=FALSE,row.names=1)
head(mr)
str(mr)</code></pre>
<pre><code>##          SampleName     SampleID No Model Day Group Replicate
## DSSd00_1   DSSd00_1 KI_PC1606_01  1   DSS   0 day00         1
## DSSd00_2   DSSd00_2 KI_PC1606_02  2   DSS   0 day00         2
## DSSd00_3   DSSd00_3 KI_PC1606_03  3   DSS   0 day00         3
## DSSd07_1   DSSd07_1 KI_PC1606_13 13   DSS   7 day07         1
## DSSd07_2   DSSd07_2 KI_PC1606_14 14   DSS   7 day07         2
## DSSd07_3   DSSd07_3 KI_PC1606_15 15   DSS   7 day07         3
## &#39;data.frame&#39;:    6 obs. of  7 variables:
##  $ SampleName: chr  &quot;DSSd00_1&quot; &quot;DSSd00_2&quot; &quot;DSSd00_3&quot; &quot;DSSd07_1&quot; ...
##  $ SampleID  : chr  &quot;KI_PC1606_01&quot; &quot;KI_PC1606_02&quot; &quot;KI_PC1606_03&quot; &quot;KI_PC1606_13&quot; ...
##  $ No        : int  1 2 3 13 14 15
##  $ Model     : chr  &quot;DSS&quot; &quot;DSS&quot; &quot;DSS&quot; &quot;DSS&quot; ...
##  $ Day       : int  0 0 0 7 7 7
##  $ Group     : chr  &quot;day00&quot; &quot;day00&quot; &quot;day00&quot; &quot;day07&quot; ...
##  $ Replicate : int  1 2 3 1 2 3</code></pre>
<p>The most relevant metadata columns are <strong>sampleName</strong> and <strong>Group</strong>. It is important to check that the number of columns of data match the number of rows of metadata. And that the column names of data match the row names of metadata.</p>
<pre class="r"><code>all.equal(colnames(cr),rownames(mr))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>Let’s create a boxplot to visualise the distribution of counts.</p>
<pre class="r"><code>boxplot(log2(as.matrix(cr)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;Raw data&quot;)</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-14-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>The median values are zero across all samples. This means that half the values in each sample are zeros. This data set would benefit from a low count filtering.</p>
<p>We can check if any samples need to be discarded based on the number of genes detected. We create a barplot of genes detected across samples.</p>
<pre class="r"><code>{barplot(colSums(cr&gt;3),ylab=&quot;Number of detected genes&quot;,las=2)
abline(h=median(colSums(cr&gt;3)))}</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-15-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>On average, about 11495.66667 genes are detected. All samples are more or less close to the average. None of the samples look bad enough to be removed.</p>
<p><i class="fas fa-comments"></i> What does <code>cr&gt;3</code> do? Why did we use 3? Is it better than using <code>cr&gt;0</code>?</p>
<p>And we can create a similar plot for detection rate across genes.</p>
<pre class="r"><code>{barplot(rowSums(cr&gt;3),xlab=&quot;Genes&quot;,ylab=&quot;Number of samples&quot;,names.arg=&quot;&quot;)
abline(h=median(rowSums(cr&gt;3)),col=&quot;red&quot;)}</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-16-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>This is hard to see. It’s perhaps easier to plot a histogram.</p>
<pre class="r"><code>hist(rowSums(cr&gt;3))</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-17-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>There are a lot of genes that are not expressed (ie; zero on x-axis) in any sample. These can be removed completely. We are mostly interested in the peak on the right. These are genes that are expressed in all samples. We don’t want to be too restrictive, so we will choose to keep genes that are expressed in atleast 3 samples since our groups have 3 samples each.</p>
<p>Below, rather than using zero as the minimum value for detection, we used minimum of 1 count-per-million (CPM). This ignores noisy background counts. And we want to keep genes that have minimum 1 CPM across 2 samples (since each of test groups consist of 3 samples).</p>
<pre class="r"><code># remove genes with low counts
keep_genes &lt;- rowSums(edgeR::cpm(cr)&gt;1) &gt;= 2
cf &lt;- cr[keep_genes,]</code></pre>
<p><i class="fas fa-comments"></i> How would the results change if we used total number of samples (ie; 12 for this dataset) in the code above? Are there any drawbacks to doing that?</p>
<p>Distribution of the filtered counts looks like below. Compare this to the previous boxplot above.</p>
<pre class="r"><code>boxplot(log2(as.matrix(cf)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;Filtered data&quot;)</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-19-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>In addition, compare the histogram of filtered counts below to the raw data above.</p>
<pre class="r"><code>hist(rowSums(cf&gt;3))</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-20-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>The missingness in the data set is reduced. The filtering process has removed 37852 genes with low counts.</p>
<p>Since no samples were discarded, the metadata file will remain the same. And we can check that the labels are the same order in counts and metadata.</p>
<pre class="r"><code>all.equal(colnames(cf),rownames(mr))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>At this point, we can save the filtered data.</p>
<pre class="r"><code>write.csv(cf,&quot;./data/gene_counts_filtered.csv&quot;,quote=F)</code></pre>
</div>
<div id="normalisation" class="section level1">
<h1><span class="header-section-number">3</span> Normalisation</h1>
<p>The raw count data needs to be corrected for various biases before statistical inference. If the data set is to be used in an R package for differential gene expression such as <strong>DESeq2</strong>, <strong>edgeR</strong> or <strong>Limma</strong>, you must provide the <strong>raw data</strong> directly. This is because, these packages handle the correction and transformation internally. In addition, these packages do not control for gene length. Therefore, for custom analyses and gene-to-gene comparison, the raw data needs to be normalised.</p>
<div id="cpmtpm" class="section level2">
<h2><span class="header-section-number">3.1</span> CPM/TPM</h2>
<p>For analysis other than DGE, the data set must be corrected before use. The most basic correction required is sequencing depth. This is achieved using rescaling the counts to counts per million.</p>
<p>We read in out filtered count data and metadata. We can use the function <code>cpm()</code> from R package <strong>edgeR</strong> for this.</p>
<pre class="r"><code>download_data(&quot;data/gene_counts_filtered.csv&quot;)
cf &lt;- read.csv(&quot;data/gene_counts_filtered.csv&quot;,stringsAsFactors=F,row.names=1)

download_data(&quot;data/metadata_raw.csv&quot;)
mr &lt;- read.csv(&quot;data/metadata_raw.csv&quot;,stringsAsFactors=F,row.names=1)

all.equal(colnames(cf),rownames(mr))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>cc &lt;- edgeR::cpm(cf)
boxplot(log2(as.matrix(cc)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;CPM&quot;)</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-24-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>But, CPM data has some drawbacks. It is not suitable for within-sample comparisons. The total number of reads per sample varies from sample to sample. This also makes it harder to compare one experiment to another. In addition, gene length is not controlled for in this correction. RPKM/FPKM normalisations correct for gene length, but they are not recommended because they are not comparable between samples.</p>
<p>A better correction method that resolves sequencing depth and gene length is TPM (transcripts-per-million). The code for computing TPM is simple.</p>
<pre class="r"><code>#&#39; @title Compute TPM from a read count matrix
#&#39; @param counts A numeric data.frame of read counts with samples (columns) and genes (rows).
#&#39; @param len A vector of gene cds length equal to number of rows of dfr.
#&#39;
#&#39; https://support.bioconductor.org/p/91218/
#&#39;
tpm &lt;- function(counts,len) {
  x &lt;- counts/len
  return(t(t(x)*1e6/colSums(x)))
}</code></pre>
<p>We read in the annotation data and find shared genes between count data and annotation data and match their order.</p>
<pre class="r"><code>download_data(&quot;data/mouse_genes.txt&quot;)
g &lt;- read.delim(&quot;data/mouse_genes.txt&quot;,stringsAsFactors=F)
g &lt;- g[!duplicated(g$external_gene_name),]

igenes &lt;- intersect(rownames(cf),g$external_gene_name)
g1 &lt;- g[g$external_gene_name %in% igenes,]
cf1 &lt;- cf[rownames(cf) %in% igenes,]

g1 &lt;- g1[match(rownames(cf1),g1$external_gene_name),]
g1$len &lt;- g1$end_position - g1$start_position
all.equal(rownames(cf1),g1$external_gene_name)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>And then we run the <code>tpm()</code> function on the count data using the gene lengths. And then we create a boxplot of the resulting values.</p>
<pre class="r"><code>ct &lt;- tpm(cf1,g1$len)
boxplot(log2(as.matrix(ct)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;TPM&quot;)</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-27-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>This is the distribution of TPM counts.</p>
</div>
<div id="deseq2" class="section level2">
<h2><span class="header-section-number">3.2</span> DESeq2</h2>
<p>DESeq2 internally corrects counts for sequencing depth and RNA compositional bias using <strong>Median of ratios</strong> method. The details of this method are described further in the DGE lab. To run this method, we create a DESeq2 object using the count data and metadata.</p>
<pre class="r"><code>library(DESeq2)
mr$Group &lt;- factor(mr$Group)
d &lt;- DESeqDataSetFromMatrix(countData=cf,colData=mr,design=~Group)
d &lt;- DESeq2::estimateSizeFactors(d,type=&quot;ratio&quot;)
cd &lt;- counts(d,normalized=TRUE)
saveRDS(cd,&quot;data/gene_counts_normalised_deseq2.Rds&quot;)</code></pre>
<pre class="r"><code>cd &lt;- readRDS(&quot;data/gene_counts_normalised_deseq2.Rds&quot;)
boxplot(log2(as.matrix(cd)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;DESeq2&quot;)</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-29-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
</div>
<div id="vst" class="section level2">
<h2><span class="header-section-number">3.3</span> VST</h2>
<p>For the purpose of exploratory analysis such as MDS, PCA, clustering etc, VST (variance-stabilizing-transformation) is recommended. VST is also run using DESeq2. As in the previous step, a DESeq2 object is created.</p>
<pre class="r"><code>library(DESeq2)
mr$Group &lt;- factor(mr$Group)
d &lt;- DESeqDataSetFromMatrix(countData=cf,colData=mr,design=~Group)
d &lt;- DESeq2::estimateSizeFactors(d,type=&quot;ratio&quot;)
d &lt;- DESeq2::estimateDispersions(d)
cv &lt;- as.data.frame(assay(varianceStabilizingTransformation(d,blind=T)),check.names=F)

write.csv(cv,&quot;./data/gene_counts_vst.csv&quot;,quote=FALSE)

boxplot(log2(as.matrix(cv)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;VST&quot;)</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-30-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>The effect of VST transformation can be clearly seen in a mean vs variance plot.</p>
<pre class="r"><code>rowVar &lt;- function(x) apply(x,1,var)
rafalib::mypar(mfrow=c(2,2))
plot(rowMeans(log2(cf+1)),rowVar(log2(cf+1)),xlab=expression(&#39;Log&#39;[2]~&#39;Mean count&#39;),ylab=expression(&#39;Log&#39;[2]~&#39;Variance&#39;),main=&quot;Filtered&quot;,cex=.1)
plot(rowMeans(log2(ct+1)),rowVar(log2(ct+1)),xlab=expression(&#39;Log&#39;[2]~&#39;Mean count&#39;),ylab=expression(&#39;Log&#39;[2]~&#39;Variance&#39;),main=&quot;TPM&quot;,cex=.1)
plot(rowMeans(log2(cd+1)),rowVar(log2(cd+1)),xlab=expression(&#39;Log&#39;[2]~&#39;Mean count&#39;),ylab=expression(&#39;Log&#39;[2]~&#39;Variance&#39;),main=&quot;DESeq2&quot;,cex=.1)
plot(rowMeans(cv),rowVar(cv),xlab=expression(&#39;Log&#39;[2]~&#39;Mean count&#39;),ylab=expression(&#39;Log&#39;[2]~&#39;Variance&#39;),main=&quot;VST&quot;,cex=.1)
rafalib::mypar(mar=c(6,2.5,2.5,1))</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-31-1.svg" width="672" style="display: block; margin: auto auto auto 0;" /></p>
<p>For RNA-seq data, as the mean count value increases, the variance increases. There is a strong almost linear relationship as seen in the figures. The statistical methods such as PCA expects similar variance across the range of mean values. If not, the higher variance genes will contribute more than the lower variance genes. Such data is said to be heteroscedastic and needs to be corrected. One option is log transformation (with pseudocount), but this tends to inflate the contribution of the low variance genes. To obtain similar variance across the whole range of mean values, DESeq2 offers two methods VST (variance stabilising transformation) and RLOG (regularised log transformation).</p>
<p>As the name suggests, VST transformation stabilizes variance across the whole range of count values. VST is recommended for clustering or visualisation. It is not intended for differential gene expression. If the size factors vary dramatically between samples, then RLOG transformation is recommended. A comparable approach is voom transformation from the R package limma.</p>
</div>
<div id="conclusion" class="section level2">
<h2><span class="header-section-number">3.4</span> Conclusion</h2>
<p>Finally, we can compare all of the various transformations in a single plot.</p>
<pre class="r"><code>rafalib::mypar(1,4,mar=c(6,2.5,2.5,1) )
boxplot(log2(as.matrix(cf)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;Filtered&quot;)
boxplot(log2(as.matrix(ct)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;TPM&quot;)
boxplot(log2(as.matrix(cd)+1),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;DESeq2&quot;)
boxplot(as.matrix(cv),ylab=expression(&#39;Log&#39;[2]~&#39;Read counts&#39;),las=2,main=&quot;VST&quot;)
rafalib::mypar(mar=c(6,2.5,2.5,1))</code></pre>
<p><img src="lab_preprocessing_files/figure-html/unnamed-chunk-32-1.svg" width="864" style="display: block; margin: auto auto auto 0;" /></p>
<p><i class="fas fa-comments"></i> Would it be possible to have one perfect normalisation method for all types of analyses? Is there any drawback to using gene length corrected counts in differential gene expression analyses?</p>
<hr />
</div>
</div>


<footer class="footer">
<div class="container footer-container">
<div class="row">
  
<div class="col-sm-8" style="text-align:left;vertical-align:middle;">
<p class="small" style="color:#bdbdbd;">
<b>2020</b> • NBIS • SciLifeLab
</p>
</div>

<div class="col-sm-4" style="text-align:right;vertical-align:middle;">
<p style="color:#bdbdbd;">
<span>
  <span class="footericon" style="padding-right:4px; padding-left:4px">
    <a href="https://nbis.se/">
      <svg style="height:0.8em;top:.04em;position:relative;fill:#bdbdbd;" viewBox="0 0 496 512"><path d="M248 8C111.03 8 0 119.03 0 256s111.03 248 248 248 248-111.03 248-248S384.97 8 248 8zm82.29 357.6c-3.9 3.88-7.99 7.95-11.31 11.28-2.99 3-5.1 6.7-6.17 10.71-1.51 5.66-2.73 11.38-4.77 16.87l-17.39 46.85c-13.76 3-28 4.69-42.65 4.69v-27.38c1.69-12.62-7.64-36.26-22.63-51.25-6-6-9.37-14.14-9.37-22.63v-32.01c0-11.64-6.27-22.34-16.46-27.97-14.37-7.95-34.81-19.06-48.81-26.11-11.48-5.78-22.1-13.14-31.65-21.75l-.8-.72a114.792 114.792 0 0 1-18.06-20.74c-9.38-13.77-24.66-36.42-34.59-51.14 20.47-45.5 57.36-82.04 103.2-101.89l24.01 12.01C203.48 89.74 216 82.01 216 70.11v-11.3c7.99-1.29 16.12-2.11 24.39-2.42l28.3 28.3c6.25 6.25 6.25 16.38 0 22.63L264 112l-10.34 10.34c-3.12 3.12-3.12 8.19 0 11.31l4.69 4.69c3.12 3.12 3.12 8.19 0 11.31l-8 8a8.008 8.008 0 0 1-5.66 2.34h-8.99c-2.08 0-4.08.81-5.58 2.27l-9.92 9.65a8.008 8.008 0 0 0-1.58 9.31l15.59 31.19c2.66 5.32-1.21 11.58-7.15 11.58h-5.64c-1.93 0-3.79-.7-5.24-1.96l-9.28-8.06a16.017 16.017 0 0 0-15.55-3.1l-31.17 10.39a11.95 11.95 0 0 0-8.17 11.34c0 4.53 2.56 8.66 6.61 10.69l11.08 5.54c9.41 4.71 19.79 7.16 30.31 7.16s22.59 27.29 32 32h66.75c8.49 0 16.62 3.37 22.63 9.37l13.69 13.69a30.503 30.503 0 0 1 8.93 21.57 46.536 46.536 0 0 1-13.72 32.98zM417 274.25c-5.79-1.45-10.84-5-14.15-9.97l-17.98-26.97a23.97 23.97 0 0 1 0-26.62l19.59-29.38c2.32-3.47 5.5-6.29 9.24-8.15l12.98-6.49C440.2 193.59 448 223.87 448 256c0 8.67-.74 17.16-1.82 25.54L417 274.25z"></path>
      </svg>
    </a>
    </span>
    <span class="footericon" style="padding-right:4px; padding-left:4px">
      <a href="https://twitter.com/NBISwe"><svg style="height:0.8em;top:.04em;position:relative;fill:#bdbdbd;" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
    </svg>
    </a>
    </span>
    <span class="footericon" style="padding-left:4px">
      <a href="https://www.linkedin.com/company/nbisweden/">
        <svg style="height:0.8em;top:.04em;position:relative;fill:#bdbdbd;" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path>
        </svg>
    </a>
    </span>
  </span>
</p>
</div>

</div>
</div>
</footer>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
